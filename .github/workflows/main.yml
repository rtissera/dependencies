name: Build Dependencies

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '**.txt'

permissions:
  contents: write

jobs:
  build-linux-x64:
    name: "ðŸ§ Linux x64"
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    steps:
    - uses: actions/checkout@v6

    - name: Install Packages
      run: ./install-packages-linux.sh

    - name: Build Dependencies
      run: ./build-dependencies-linux.sh linux-x64

    - name: Build FFmpeg
      run: ./build-ffmpeg-linux.sh linux-x64

    - name: Create Archive
      run: tar -cJf deps-linux-x64.tar.xz linux-x64

    - name: Upload Artifact
      uses: actions/upload-artifact@v6
      with:
        name: deps-linux-x64
        path: deps-linux-x64.tar.xz
        compression-level: 0
        if-no-files-found: error

  build-linux-riscv64:
    name: "ðŸ§ Linux riscv64"
    needs: build-linux-x64
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/rtissera/cross-build-riscv64:latest
    timeout-minutes: 240
    steps:
    - uses: actions/checkout@v6

    - name: Download x64 Artifact
      uses: actions/download-artifact@v6
      with:
        name: deps-linux-x64
        path: ./deps-linux-x64

    - name: Extract x64 Artifact
      run: |
        tar -xvf deps-linux-x64/deps-linux-x64.tar.xz

    - name: Build Dependencies
      run: |
        ./build-dependencies-linux-cross.sh -skip-qt "linux-x64" "riscv64" "/riscv64-chroot" "linux-cross-riscv64"

    - name: Create Archive
      run: tar -cJf "deps-linux-cross-riscv64.tar.xz" "linux-cross-riscv64"

    - name: Upload Artifact
      uses: actions/upload-artifact@v6
      with:
        name: deps-linux-cross-riscv64
        path: deps-linux-cross-riscv64.tar.xz
        compression-level: 0
        if-no-files-found: error

  create-release:
    name: "ðŸ“¤ Create Release"
    if: github.ref == 'refs/heads/master'
    needs: [build-linux-x64, build-linux-riscv64]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Get Current Date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> "$GITHUB_OUTPUT"

    - name: Download All Artifacts
      uses: actions/download-artifact@v6
      with:
        path: artifacts

    - name: Create Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG="release-${{ steps.date.outputs.date }}"
        gh release delete "$TAG" --yes --cleanup-tag || true
        gh release create "$TAG" \
          --title "$TAG" \
          --notes "Dependencies built on $(date +'%Y-%m-%d') from commit ${{ github.sha }}." \
          artifacts/deps-linux-x64/deps-linux-x64.tar.xz \
          artifacts/deps-linux-cross-riscv64/deps-linux-cross-riscv64.tar.xz
